<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Flashcard Studio (Final)</title>
    <style>
        :root {
            --primary: #f97316; /* Brand Orange */
            --bg: #fff7ed;
            --surface: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { margin-bottom: 1rem; color: #c2410c; }

        .container {
            background: var(--surface);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }

        .col { display: flex; flex-direction: column; gap: 1.2rem; }

        label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
            color: #431407;
        }

        input[type="file"], select, input[type="text"], input[type="color"] {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #fdba74;
            border-radius: 6px;
            box-sizing: border-box; 
            font-family: inherit;
        }

        /* Grouping Inputs */
        .input-group {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
        }

        /* Playlist Styling */
        .playlist-container {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #fff;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .playlist-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }

        .playlist-item input {
            width: 70px;
            padding: 5px;
        }

        /* Buttons */
        .btn-primary {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            width: 100%;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-primary:hover { background-color: #ea580c; }
        .btn-primary:disabled { background-color: #cbd5e1; cursor: not-allowed; }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #ffedd5;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #fdba74;
            cursor: pointer;
        }

        /* Preview Area */
        .preview-area {
            grid-column: 1 / -1;
            text-align: center;
            display: none;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px dashed #fdba74;
        }

        video {
            max-width: 100%;
            max-height: 500px;
            border: 4px solid #000;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .status-bar {
            grid-column: 1 / -1;
            background: #e2e8f0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }
        .status-fill {
            height: 100%;
            width: 0%;
            background: var(--primary);
            transition: width 0.1s linear;
        }
        
        canvas { display: none; }
    </style>
</head>
<body>

    <h1>Flashcard Video Studio Pro</h1>

    <div class="container">
        
        <div class="col">
            <div>
                <label>1. Video Format</label>
                <select id="format">
                    <option value="feed">Instagram Feed (1080x1080)</option>
                    <option value="story">Story / Reels / TikTok (1080x1920)</option>
                    <option value="youtube">YouTube Landscape (1920x1080)</option>
                </select>
            </div>

            <div class="input-group">
                <label>2. Design Settings</label>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <span>Background Color:</span>
                    <input type="color" id="bgColor" value="#f97316" style="width: 50px; padding: 2px; height: 35px;">
                </div>
                
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="addOutro" checked> 
                    <strong>Add "Outro" Slide (3 Secs)</strong>
                </label>
                <small style="display:block; margin-top:5px; color:#666;">
                    Shows centered Logo, Social Links, and Website.
                </small>
            </div>

            <div>
                <label>3. Background Music</label>
                <select id="musicSelect">
                    <option value="none">No Music</option>
                    <option value="track1">Peaceful/Nature (Track 1)</option>
                    <option value="track2">Upbeat/Lofi (Track 2)</option>
                    <option value="track3">Cinematic (Track 3)</option>
                </select>
                <small style="color: #666; font-size: 0.8em;">*Ensure files exist in your folder or use URLs</small>
            </div>
        </div>

        <div class="col">
            <div>
                <label>4. Upload Images</label>
                <input type="file" id="imageInput" multiple accept="image/*" onchange="handleImageUpload()">
            </div>

            <label>5. Playlist & Duration (Secs per slide)</label>
            <div class="playlist-container" id="playlistContainer">
                <p style="text-align: center; color: #999; margin-top: 50px;">Upload images to see them here.</p>
            </div>
        </div>

        <div class="status-bar" id="progressBar"><div class="status-fill" id="progressFill"></div></div>
        <p id="statusText" style="grid-column: 1/-1; text-align: center;"></p>
        
        <button id="generateBtn" class="btn-primary" onclick="startGeneration()" style="grid-column: 1/-1;">Generate Video</button>

        <div class="preview-area" id="resultArea">
            <h3>Video Ready!</h3>
            <video id="outputVideo" controls playsinline></video>
            <br>
            <a id="downloadLink" href="#" download="video.mp4">
                <button style="background-color: #16a34a; width: auto; padding: 10px 40px; border:none; border-radius:6px; color:white; font-size:1rem; cursor:pointer;">Download MP4</button>
            </a>
        </div>

    </div>

    <canvas id="canvas"></canvas>

    <script>
        // ==========================================
        //  1. CONFIGURATION (EDIT HERE)
        // ==========================================
        
        // 1.1 Hardcoded Social Handles
        const SOCIAL_HANDLES = {
            fb: "My Facebook Page",
            ig: "@my.instagram",
            yt: "My Channel Name"
        };

        const WEBSITE_URL = "https://eptonline.org";
        
        // 1.2 PNG Icon Links (Replace with your actual PNG URLs)
        // Using placeholders for demonstration.
        const ICONS = {
            fb: 'https://cdn-icons-png.flaticon.com/512/5968/5968764.png',
            ig: 'https://cdn-icons-png.flaticon.com/512/3955/3955024.png',
            yt: 'https://cdn-icons-png.flaticon.com/512/3670/3670147.png'
        };

        // 1.3 Music Tracks (Replace with your local paths or URLs)
        // Ensure these files exist or are valid URLs.
        const MUSIC_TRACKS = {
            track1: 'path/to/music1.mp3', 
            track2: 'path/to/music2.mp3',
            track3: 'path/to/music3.mp3'
        };

        // 1.4 Logo (Base64)
        const LOGO_BASE64 = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2ZmZCIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwb2x5Z29uIHBvaW50cz0iMTIgMiAxNS4wOSA4LjI2IDIyIDkuMjcgMTcgMTQuMTQgMTguMTggMjEuMDIgMTIgMTcuNzcgNS44MiAyMS4wMiA3IDE0LjE0IDIgOS4yNyA4LjkxIDguMjYgMTIgMiIvPjwvc3ZnPg==";


        // ==========================================
        //  2. APP LOGIC
        // ==========================================

        let playlist = []; 
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        const assets = { logo: null, icons: {}, slides: [] };

        function handleImageUpload() {
            const input = document.getElementById('imageInput');
            const container = document.getElementById('playlistContainer');
            
            if(input.files.length > 0) {
                container.innerHTML = ''; 
                playlist = [];
            }

            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                playlist.push({ file: file, duration: 3 });

                const div = document.createElement('div');
                div.className = 'playlist-item';
                
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                
                const name = document.createElement('span');
                name.innerText = file.name.substring(0, 15) + "...";
                name.style.flexGrow = 1;
                name.style.fontSize = "0.9rem";

                const durInput = document.createElement('input');
                durInput.type = 'number';
                durInput.value = 3;
                durInput.min = 1;
                durInput.step = 0.5;
                durInput.addEventListener('change', (e) => {
                    playlist[i].duration = parseFloat(e.target.value);
                });

                div.appendChild(img);
                div.appendChild(name);
                div.appendChild(durInput);
                container.appendChild(div);
            }
        }

        async function startGeneration() {
            if (playlist.length === 0) return alert("Please upload images first.");

            const format = document.getElementById('format').value;
            const bgColor = document.getElementById('bgColor').value;
            const useOutro = document.getElementById('addOutro').checked;
            const musicChoice = document.getElementById('musicSelect').value;
            const btn = document.getElementById('generateBtn');
            const status = document.getElementById('statusText');

            // Reset UI
            btn.disabled = true;
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('progressBar').style.display = 'block';

            // Set Canvas Dimensions
            const dims = {
                feed: { w: 1080, h: 1080 },
                story: { w: 1080, h: 1920 },
                youtube: { w: 1920, h: 1080 }
            };
            canvas.width = dims[format].w;
            canvas.height = dims[format].h;

            // --- LOAD ASSETS ---
            status.innerText = "Loading assets...";
            
            assets.logo = await safeLoad(LOGO_BASE64);
            assets.icons.fb = await safeLoad(ICONS.fb);
            assets.icons.ig = await safeLoad(ICONS.ig);
            assets.icons.yt = await safeLoad(ICONS.yt);
            
            assets.slides = [];
            let slidesTotalTime = 0;
            
            for (let item of playlist) {
                const img = await safeLoad(item.file);
                if (img) {
                    assets.slides.push({ img, duration: item.duration });
                    slidesTotalTime += item.duration;
                }
            }

            if(assets.slides.length === 0) {
                alert("Error: No images loaded.");
                btn.disabled = false;
                return;
            }

            // Calc Total Duration
            const outroDuration = useOutro ? 3 : 0;
            const finalDuration = slidesTotalTime + outroDuration;

            // --- AUDIO SETUP ---
            let audioCtx, audioDest, audioStream;
            
            if (musicChoice !== 'none') {
                try {
                    status.innerText = "Loading Music...";
                    // Check if URL is valid or dummy
                    const trackUrl = MUSIC_TRACKS[musicChoice];
                    if(trackUrl.includes('path/to/')) {
                        console.warn("Using dummy music path. Audio might fail if file missing.");
                    }

                    const response = await fetch(trackUrl);
                    if (!response.ok) throw new Error("Music file not found");
                    const buf = await response.arrayBuffer();

                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const audioBuf = await audioCtx.decodeAudioData(buf);
                    
                    audioDest = audioCtx.createMediaStreamDestination();
                    audioStream = audioDest.stream;
                    
                    const src = audioCtx.createBufferSource();
                    src.buffer = audioBuf;
                    src.loop = true;
                    src.connect(audioDest);
                    src.start(0);
                    // Stop audio slightly after video ends
                    setTimeout(() => {
                        try { src.stop(); audioCtx.close(); } catch(e){}
                    }, finalDuration * 1000 + 500); 
                } catch(e) { 
                    console.error("Audio Load Error:", e);
                    alert("Could not load music file. Check console/paths. Proceeding mute.");
                }
            }

            // --- RECORDING ---
            const stream = canvas.captureStream(30); 
            if (audioStream) audioStream.getAudioTracks().forEach(t => stream.addTrack(t));

            let mime = 'video/mp4';
            if (!MediaRecorder.isTypeSupported(mime)) mime = 'video/webm;codecs=vp9';

            const recorder = new MediaRecorder(stream, { mimeType: mime });
            const chunks = [];
            
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: mime });
                const url = URL.createObjectURL(blob);
                const vid = document.getElementById('outputVideo');
                const dl = document.getElementById('downloadLink');
                
                vid.src = url;
                dl.href = url;
                dl.download = `flashcard_video.mp4`; 

                document.getElementById('resultArea').style.display = 'block';
                status.innerText = "Done!";
                btn.disabled = false;
            };

            recorder.start();
            status.innerText = "Rendering Video...";

            // --- RENDER LOOP ---
            const startTime = Date.now();
            
            function draw() {
                const elapsed = (Date.now() - startTime) / 1000;
                const progress = Math.min((elapsed / finalDuration) * 100, 100);
                
                document.getElementById('progressFill').style.width = `${progress}%`;
                status.innerText = `Rendering: ${elapsed.toFixed(1)}s / ${finalDuration.toFixed(1)}s`;

                if (elapsed >= finalDuration) {
                    recorder.stop();
                    return;
                }

                if (elapsed < slidesTotalTime) {
                    // SLIDE PHASE
                    let timePointer = 0;
                    let currentImg = null;
                    for (let s of assets.slides) {
                        if (elapsed >= timePointer && elapsed < timePointer + s.duration) {
                            currentImg = s.img;
                            break;
                        }
                        timePointer += s.duration;
                    }
                    if (currentImg) renderMainFrame(currentImg, bgColor, format);
                } else {
                    // OUTRO PHASE
                    if (useOutro) renderOutroFrame(bgColor);
                }
                
                requestAnimationFrame(draw);
            }
            
            draw();
        }

        // ==========================================
        //  3. DRAWING FUNCTIONS
        // ==========================================
        
        // --- 1. Main Slide Frame ---
        function renderMainFrame(img, bgColor, format) {
            const w = canvas.width;
            const h = canvas.height;

            // Background
            ctx.fillStyle = bgColor; 
            ctx.fillRect(0, 0, w, h);

            // Image
            drawImageContain(ctx, img, w, h);

            // Logo (Top Right)
            if (assets.logo) {
                const size = w * 0.15; // Scaled to Width
                const pad = w * 0.02;
                ctx.drawImage(assets.logo, w - size - pad, pad, size, size);
            }

            // Footer Bar
            drawSocialBar(ctx, w, h, format);
        }

        // --- 2. Outro Frame (Centered) ---
        function renderOutroFrame(bgColor) {
            const w = canvas.width;
            const h = canvas.height;

            // Background
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, w, h);

            // Setup Text
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            
            // Calculate Centered Positions based on height percentages
            const logoY = h * 0.3;
            const textY = h * 0.5;
            const socialY = h * 0.65;

            // 1. Logo
            if(assets.logo) {
                const size = w * 0.25; // 25% of width
                const x = (w - size) / 2;
                ctx.drawImage(assets.logo, x, logoY - (size/2), size, size);
            }

            // 2. Website Text
            ctx.font = `bold ${w * 0.06}px Arial`;
            ctx.fillText(WEBSITE_URL, w/2, textY);

            // 3. "Follow Us"
            ctx.font = `${w * 0.04}px Arial`;
            ctx.fillText("Follow us for more!", w/2, textY + (w * 0.07));

            // 4. Centered Socials (No Bar, just icons and text in middle)
            drawCenteredSocials(ctx, w, h, socialY);
        }

        // --- 3. Footer Bar (Dynamic Resizing) ---
        function drawSocialBar(ctx, w, h, format) {
            // Case 1: Dynamic Height based on Width (Fixes the resize issue)
            // Using 8% of width guarantees it looks proportionate on all screens
            // But we clamp it so it doesn't get too small on Landscape
            let barHeight = w * 0.08; 
            if (format === 'youtube') barHeight = h * 0.12; // Slightly taller for landscape
            
            const fontSize = barHeight * 0.35;
            const iconSize = barHeight * 0.5;

            // Draw Bar Background
            ctx.fillStyle = "rgba(0,0,0,0.8)";
            ctx.fillRect(0, h - barHeight, w, barHeight);

            // Draw Items
            const startY = h - (barHeight/2);
            drawHorizontalHandles(ctx, w, startY, iconSize, fontSize);
        }

        // --- 4. Centered Socials (For Outro) ---
        function drawCenteredSocials(ctx, w, h, startY) {
            const iconSize = w * 0.08; // Bigger icons for outro
            const fontSize = w * 0.05; // Bigger text
            
            drawHorizontalHandles(ctx, w, startY, iconSize, fontSize);
        }

        // Helper to draw handles horizontally centered at a specific Y
        function drawHorizontalHandles(ctx, w, centerY, iconSize, fontSize) {
            ctx.fillStyle = "white";
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = "left";
            ctx.textBaseline = "middle";

            // Prepare items
            const items = [];
            if (SOCIAL_HANDLES.fb) items.push({ icon: assets.icons.fb, text: SOCIAL_HANDLES.fb });
            if (SOCIAL_HANDLES.ig) items.push({ icon: assets.icons.ig, text: SOCIAL_HANDLES.ig });
            if (SOCIAL_HANDLES.yt) items.push({ icon: assets.icons.yt, text: SOCIAL_HANDLES.yt });

            const gap = w * 0.04;
            
            // Calculate total width to center the group
            let totalWidth = 0;
            items.forEach(item => {
                const textW = ctx.measureText(item.text).width;
                totalWidth += iconSize + (gap/2) + textW;
            });
            totalWidth += (items.length - 1) * gap;

            let currentX = (w - totalWidth) / 2;

            items.forEach(item => {
                // Icon
                if (item.icon) {
                    ctx.drawImage(item.icon, currentX, centerY - (iconSize/2), iconSize, iconSize);
                }
                currentX += iconSize + (gap/2);
                
                // Text
                ctx.fillText(item.text, currentX, centerY);
                currentX += ctx.measureText(item.text).width + gap;
            });
        }

        // ==========================================
        //  HELPERS
        // ==========================================
        async function safeLoad(src) {
            if(!src) return null;
            return new Promise(resolve => {
                const img = new Image();
                img.crossOrigin = "anonymous"; // Important for external PNGs
                img.onload = () => resolve(img);
                img.onerror = () => {
                    console.warn("Failed to load image:", src);
                    resolve(null);
                }
                if (src instanceof Blob) img.src = URL.createObjectURL(src);
                else img.src = src;
            });
        }

        function drawImageContain(ctx, img, targetW, targetH) {
            const imgRatio = img.width / img.height;
            const targetRatio = targetW / targetH;
            let drawW, drawH;

            if (imgRatio > targetRatio) {
                drawW = targetW;
                drawH = targetW / imgRatio;
            } else {
                drawW = targetH * imgRatio;
                drawH = targetH;
            }
            const x = (targetW - drawW) / 2;
            const y = (targetH - drawH) / 2;
            ctx.drawImage(img, x, y, drawW, drawH);
        }
    </script>
</body>
</html>
